from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler,
    ContextTypes, CallbackQueryHandler
)
import hashlib

# ================== Cáº¤U HÃŒNH ==================

TOKEN = "8561271538:AAEqmE_DcB3RZE2ln6Ig7zDTrCOReZ9EraY"

# ID ADMIN (láº¥y báº±ng @userinfobot)
ADMIN_IDS = {8129411808}  # thay báº±ng ID Telegram cá»§a báº¡n

VALID_KEYS = set()
USER_KEYS = {}

# ================== THUáº¬T TOÃN MD5 (á»”N Äá»ŠNH) ==================

def md5_engine(md5: str):
    seed = int(hashlib.sha256(md5.encode()).hexdigest(), 16)

    nums = sum(c.isdigit() for c in md5)
    chars = sum(c.isalpha() for c in md5)

    balance = nums - chars
    entropy = len(set(md5)) // 4
    weight = (seed % 3) + 1

    total = balance + entropy + weight

    result = "TÃ i ğŸŸ¡" if total >= 2 else "Xá»‰u ğŸ”µ"
    trend = "TÄ‚NG NHáº¸ (8-10)" if total >= 3 else "ÄI NGANG"
    confidence = min(97.0, 90 + abs(total) * 1.1)
    verify = hex(seed % 0xFFFFFF)[2:].upper()

    return total, trend, result, round(confidence, 1), verify

# ================== /START ==================

async def start_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸ”‘ Nháº­p KEY", callback_data="enter_key")],
        [InlineKeyboardButton("ğŸ“Š PhÃ¢n tÃ­ch MD5", callback_data="enter_md5")]
    ]
    await update.message.reply_text(
        "ğŸ¤– Bot phÃ¢n tÃ­ch MD5\n"
        "ğŸ‘¤ Bot do Äá»©c TrÃ­ táº¡o\n"
        "âš ï¸ Káº¿t quáº£ chá»‰ mang tÃ­nh tham kháº£o\n",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ================== INLINE BUTTON ==================

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "enter_key":
        await query.message.reply_text("â¡ï¸ Nháº­p key báº±ng lá»‡nh:\n/key <KEY>")
    elif query.data == "enter_md5":
        await query.message.reply_text("â¡ï¸ DÃ¹ng lá»‡nh:\n/md5 <chuá»—i_md5>")

# ================== /KEY ==================

async def key_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if len(context.args) != 1:
        await update.message.reply_text("âŒ DÃ¹ng: /key <KEY>")
        return

    key = context.args[0]

    if key not in VALID_KEYS:
        await update.message.reply_text("âŒ KEY khÃ´ng há»£p lá»‡")
        return

    USER_KEYS[user_id] = key
    await update.message.reply_text("âœ… KÃ­ch hoáº¡t KEY thÃ nh cÃ´ng")

# ================== /MD5 ==================

async def md5_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if user_id not in USER_KEYS:
        await update.message.reply_text("ğŸ”’ Vui lÃ²ng nháº­p KEY trÆ°á»›c: /key <KEY>")
        return

    if len(context.args) != 1:
        await update.message.reply_text("âŒ DÃ¹ng: /md5 <md5>")
        return

    md5 = context.args[0].lower()

    if len(md5) != 32 or not all(c in "0123456789abcdef" for c in md5):
        await update.message.reply_text("âŒ MD5 pháº£i Ä‘á»§ 32 kÃ½ tá»± hex")
        return

    score, trend, result, conf, verify = md5_engine(md5)

    msg = f"""
âš¡ PHÃ‚N TÃCH MD5 âš¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”‘ MÃƒ MD5:
{md5}

ğŸ“Š Tá»”NG ÄIá»‚M: {score}
ğŸ“ˆ XU HÆ¯á»šNG: {trend}

ğŸ›¡ Äá»˜ TIN Cáº¬Y: {conf}%

ğŸ¯ Káº¾T QUáº¢: {result}
ğŸ†” MÃƒ XÃC THá»°C: {verify}

ğŸ‘¤ Bot do Äá»©c TrÃ­ táº¡o
âš ï¸ Káº¿t quáº£ chá»‰ mang tÃ­nh cháº¥t tham kháº£o,
âš ï¸ khÃ´ng cháº¯c cháº¯n Ä‘Ãºng 100%
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    await update.message.reply_text(msg)

# ================== ADMIN ADD / REMOVE KEY ==================

async def addkey_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_IDS:
        return

    if len(context.args) != 1:
        await update.message.reply_text("âŒ DÃ¹ng: /addkey <KEY>")
        return

    key = context.args[0]
    VALID_KEYS.add(key)
    await update.message.reply_text(f"âœ… ÄÃ£ thÃªm KEY: {key}")

async def delkey_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_IDS:
        return

    if len(context.args) != 1:
        await update.message.reply_text("âŒ DÃ¹ng: /delkey <KEY>")
        return

    key = context.args[0]
    VALID_KEYS.discard(key)
    await update.message.reply_text(f"ğŸ—‘ ÄÃ£ xoÃ¡ KEY: {key}")

# ================== CHáº Y BOT ==================

app = ApplicationBuilder().token(TOKEN).build()

app.add_handler(CommandHandler("start", start_cmd))
app.add_handler(CommandHandler("key", key_cmd))
app.add_handler(CommandHandler("md5", md5_cmd))
app.add_handler(CommandHandler("addkey", addkey_cmd))
app.add_handler(CommandHandler("delkey", delkey_cmd))
app.add_handler(CallbackQueryHandler(button_handler))

print("ğŸ¤– Bot Ä‘ang cháº¡y...")
app.run_polling()